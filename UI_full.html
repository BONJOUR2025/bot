<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="container mx-auto p-4 space-y-6">
    <nav class="flex flex-wrap gap-2 mb-4 bg-white p-3 rounded shadow">
      <button class="px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded" onclick="showSection('employees')">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
      <button class="px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded" onclick="showSalary()">üíº –ü—Ä–æ—Å–º–æ—Ç—Ä –ó–ü</button>
      <button class="px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded" onclick="showSchedule()">üìÖ –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</button>
      <button class="px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded" onclick="showSection('payouts')">üí≥ –í—ã–ø–ª–∞—Ç—ã</button>
      <button class="px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded" onclick="showSection('adjustments')">üìà –£–¥–µ—Ä–∂–∞–Ω–∏—è/–ü—Ä–µ–º–∏–∏</button>
      <button class="px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded" onclick="showSection('vacations')">üõ´ –û—Ç–ø—É—Å–∫–∞</button>
      <button class="px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded" onclick="showSection('birthdays')">üéÇ –î–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è</button>
      <button class="px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded" onclick="showSection('messages')">‚úâ –°–æ–æ–±—â–µ–Ω–∏—è</button>
      <button class="px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded" onclick="openBroadcastModal()">üì¢ –†–∞—Å—Å—ã–ª–∫–∞</button>
      <button class="px-3 py-2 bg-blue-50 hover:bg-blue-100 rounded" onclick="showSection('requests')">üì¨ –¢–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã</button>
    </nav>

    <div id="stats" class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white rounded-xl shadow-md p-4">
        <p class="text-sm text-gray-500">–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
        <p id="stat-total" class="text-2xl font-semibold">0</p>
      </div>
      <div class="bg-white rounded-xl shadow-md p-4">
        <p class="text-sm text-gray-500">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</p>
        <p id="stat-active" class="text-2xl font-semibold">0</p>
      </div>
      <div class="bg-white rounded-xl shadow-md p-4">
        <p class="text-sm text-gray-500">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</p>
        <p id="stat-sent" class="text-2xl font-semibold">0</p>
      </div>
      <div class="bg-white rounded-xl shadow-md p-4">
        <p class="text-sm text-gray-500">–ë–ª–∏–∂–∞–π—à–∏–π –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</p>
        <p id="stat-birthday" class="text-2xl font-semibold">-</p>
      </div>
    </div>

    <div id="notifications" class="bg-white rounded shadow-md p-4 mt-4 hidden">
      <h2 class="font-semibold mb-2">–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</h2>
      <ul id="notify-list" class="text-sm space-y-1"></ul>
    </div>

    <!-- EMPLOYEES SECTION -->
    <section id="employees" class="space-y-4">
      <h1 class="text-2xl font-bold">–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h1>
    <div class="flex flex-wrap gap-4 mb-4 items-end">
      <input id="filter-name" class="border p-2 flex-grow" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏">
      <select id="filter-status" class="border p-2">
        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
        <option value="active">–ê–∫—Ç–∏–≤–µ–Ω</option>
        <option value="inactive">–£–≤–æ–ª–µ–Ω</option>
      </select>
      <input id="filter-from" type="date" class="border p-2" placeholder="–°">
      <input id="filter-to" type="date" class="border p-2" placeholder="–ü–æ">
      <button onclick="applyFilters()" class="bg-blue-500 text-white px-4 py-2 rounded">–§–∏–ª—å—Ç—Ä</button>
      <button onclick="openModal()" class="bg-green-600 text-white px-4 py-2 rounded ml-auto">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
    </div>
      <div class="overflow-x-auto shadow rounded bg-white">
        <table id="employee-table" class="min-w-full text-sm">
          <thead class="bg-gray-200"></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ADJUSTMENTS SECTION -->
    <section id="adjustments" class="hidden space-y-4">
      <h2 class="text-xl font-semibold">–£–¥–µ—Ä–∂–∞–Ω–∏—è –∏ –ü—Ä–µ–º–∏–∏</h2>
      <button onclick="openAdjModal()" class="bg-green-600 text-white px-4 py-2 rounded">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      <div class="overflow-x-auto shadow rounded bg-white">
        <table class="min-w-full text-sm table-auto">
          <thead class="bg-gray-200">
            <tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–¢–∏–ø</th><th>–ü—Ä–∏—á–∏–Ω–∞</th><th>–°—É–º–º–∞</th><th>–î–∞—Ç–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th></th></tr>
          </thead>
          <tbody id="adj-table"></tbody>
        </table>
      </div>
    </section>

    <!-- SALARY SECTION -->
    <section id="salary" class="hidden space-y-4">
      <h2 class="text-xl font-semibold">–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—Ä–ø–ª–∞—Ç—ã</h2>
      <div class="flex flex-wrap gap-2">
        <select id="salary-month-filter" class="border p-2">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>
        </select>
        <select id="salary-employee-filter" class="border p-2">
          <option value="">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
        </select>
      </div>
      <div id="salary-table-container" class="overflow-x-auto bg-white shadow rounded p-2 text-sm"></div>
    </section>

    <!-- SCHEDULE SECTION -->
    <section id="schedule" class="hidden space-y-4">
      <h2 class="text-xl font-semibold">üìÖ –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ –¥–∞—Ç–µ</h2>
      <input type="date" id="schedule-date-picker" class="border p-2" onchange="loadScheduleByDay()" />
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm table-auto">
          <thead>
            <tr class="bg-gray-200"><th>–¢–æ—á–∫–∞</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th></tr>
          </thead>
          <tbody id="schedule-by-day-body"></tbody>
        </table>
      </div>
    </section>

    <!-- PAYOUTS SECTION -->
    <section id="payouts" class="hidden space-y-4">
      <h2 class="text-xl font-semibold">–í—ã–ø–ª–∞—Ç—ã</h2>
      <div class="flex flex-wrap gap-2 items-end">
        <select id="payout-type-filter" class="border p-2">
          <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
          <option value="–ê–≤–∞–Ω—Å">–ê–≤–∞–Ω—Å</option>
          <option value="–ó–ü">–ó–ü</option>
          <option value="–î–æ–ø–ª–∞—Ç–∞">–î–æ–ø–ª–∞—Ç–∞</option>
        </select>
        <select id="payout-status-filter" class="border p-2">
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option value="–í –æ–∂–∏–¥–∞–Ω–∏–∏">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
          <option value="–û–¥–æ–±—Ä–µ–Ω–æ">–û–¥–æ–±—Ä–µ–Ω–æ</option>
          <option value="–í—ã–ø–ª–∞—á–µ–Ω–æ">–í—ã–ø–ª–∞—á–µ–Ω–æ</option>
          <option value="–û—Ç–∫–ª–æ–Ω–µ–Ω–æ">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
        </select>
        <select id="payout-employee-filter" class="border p-2">
          <option value="">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
        </select>
        <input id="payout-from" type="date" class="border p-2">
        <input id="payout-to" type="date" class="border p-2">
        <button onclick="fetchPayouts()" class="bg-blue-500 text-white px-4 py-2 rounded">–ü–æ–∏—Å–∫</button>
        <button onclick="resetPayoutFilters()" class="bg-gray-200 px-4 py-2 rounded">–°–±—Ä–æ—Å</button>
        <button onclick="deleteSelectedPayouts()" class="bg-red-500 text-white px-4 py-2 rounded">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
        <button onclick="openPayoutModal()" class="bg-green-600 text-white px-4 py-2 rounded ml-auto">–°–æ–∑–¥–∞—Ç—å –≤—ã–ø–ª–∞—Ç—É</button>
      </div>
      <div class="overflow-x-auto shadow rounded bg-white">
        <table class="min-w-full text-sm table-auto">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-2"><input type="checkbox" id="payout-select-all" onclick="toggleAllPayouts(this)"></th>
              <th class="p-2">–§–ò–û</th><th>–¢–∏–ø</th><th>–°–ø–æ—Å–æ–±</th><th>–°—É–º–º–∞</th>
              <th>–°—Ç–∞—Ç—É—Å</th><th>–í—Ä–µ–º—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="payouts-body"></tbody>
        </table>
        <div id="payoutStats" class="text-right mt-4 font-medium text-sm text-gray-600 hidden">
          <span>–ò–¢–û–ì–û: </span>
          <span id="payoutCount">‚Äî</span> –≤—ã–ø–ª–∞—Ç –Ω–∞ —Å—É–º–º—É <span id="payoutTotal">‚Äî</span> ‚ÇΩ
        </div>
      </div>
    </section>

    <!-- VACATIONS SECTION -->
    <section id="vacations" class="hidden space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">üëí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—É—Å–∫–∞–º–∏</h2>
        <div class="flex gap-2">
          <button onclick="refreshPage()" class="px-3 py-1 bg-white rounded shadow text-sm">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
          <button onclick="openVacationModal()" class="bg-green-600 text-white px-4 py-2 rounded flex items-center gap-1">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—É—Å–∫</button>
        </div>
      </div>
      <div class="space-y-2">
        <div class="flex flex-wrap items-end gap-4">
          <label class="block">
            <span class="text-sm">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</span>
            <select id="vac-filter-employee" class="border rounded p-2 w-full sm:w-48"></select>
          </label>
        </div>
        <div class="flex flex-wrap items-end gap-4">
          <label class="block">
            <span class="text-sm">–î–∞—Ç–∞ –æ—Ç</span>
            <input type="date" id="vac-filter-start" class="border rounded p-2 w-full sm:w-40" />
          </label>
          <label class="block">
            <span class="text-sm">–¥–æ</span>
            <input type="date" id="vac-filter-end" class="border rounded p-2 w-full sm:w-40" />
          </label>
          <label class="block flex-1 min-w-[8rem]">
            <span class="text-sm">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span>
            <input type="text" id="vac-filter-comment" placeholder="–ü–æ–∏—Å–∫" class="border rounded p-2 w-full" />
          </label>
          <button onclick="loadVacations()" class="btn btn-success">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
      </div>
      <div id="vac-calendar-nav" class="flex items-center justify-between mb-2"></div>
      <div class="overflow-x-auto shadow rounded bg-white">
        <table class="min-w-full text-sm" id="vacation-table"></table>
      </div>
    </section>

    <!-- BIRTHDAYS SECTION -->
    <section id="birthdays" class="hidden">
      <h2 class="text-xl font-semibold mb-2">–í—Å–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è</h2>
      <table class="min-w-full bg-white border rounded shadow">
        <thead>
          <tr class="bg-gray-200 text-sm">
            <th class="p-2 text-left">–§–ò–û</th>
            <th class="p-2 text-left">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
            <th class="p-2 text-left">–í–æ–∑—Ä–∞—Å—Ç</th>
            <th class="p-2 text-left">–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π</th>
          </tr>
        </thead>
        <tbody id="birthdays-body"></tbody>
      </table>
    </section>

    <!-- MESSAGES SECTION -->
    <section id="messages" class="hidden space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">–°–æ–æ–±—â–µ–Ω–∏—è</h2>
        <button onclick="openMessageModal()" class="bg-blue-600 text-white px-4 py-2 rounded">üì® –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
      </div>
      <div class="overflow-x-auto shadow rounded bg-white">
        <table class="min-w-full text-sm" id="messages-table">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-2">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>
              <th class="p-2">–¢–µ–∫—Å—Ç</th>
              <th class="p-2">–§–æ—Ç–æ</th>
              <th class="p-2">–î–∞—Ç–∞</th>
              <th class="p-2">–°—Ç–∞—Ç—É—Å</th>
              <th class="p-2">–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
          </thead>
          <tbody id="messages-body"></tbody>
        </table>
      </div>
    </section>

    <!-- REQUESTS SECTION -->
    <section id="requests" class="hidden">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">–¢–µ–∫—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã</h2>
        <button onclick="loadActiveRequests()" class="px-3 py-1 bg-white rounded shadow text-sm">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="overflow-x-auto">
        <table id="requests-table" class="min-w-full text-sm table-auto">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-2 text-left">–ò–º—è</th>
              <th class="p-2 text-left">–°—É–º–º–∞</th>
              <th class="p-2 text-left">–°–ø–æ—Å–æ–±</th>
              <th class="p-2 text-left">–¢–∏–ø</th>
              <th class="p-2 text-left">–°—Ç–∞—Ç—É—Å</th>
              <th class="p-2 text-left">–î–∞—Ç–∞</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  <div id="modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-4 rounded shadow-xl w-full max-w-md space-y-2">
      <h2 id="modal-title" class="text-xl font-semibold">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
      <input id="emp-id" class="border p-2 w-full" placeholder="ID">
      <input id="emp-name" class="border p-2 w-full" placeholder="–ò–º—è">
      <input id="emp-full_name" class="border p-2 w-full" placeholder="–§–ò–û">
      <input id="emp-birthdate" type="date" class="border p-2 w-full">
      <input id="emp-phone" class="border p-2 w-full" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
      <input id="emp-bank" class="border p-2 w-full" placeholder="–ë–∞–Ω–∫">
      <select id="emp-status" class="border p-2 w-full">
        <option value="active">–ê–∫—Ç–∏–≤–µ–Ω</option>
        <option value="inactive">–£–≤–æ–ª–µ–Ω</option>
      </select>
      <input id="emp-photo" type="file" class="border p-2 w-full" accept="image/*">
      <textarea id="emp-note" class="border p-2 w-full" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ"></textarea>
      <div class="flex justify-end gap-2 pt-2">
        <button onclick="closeModal()" class="px-4 py-2">–û—Ç–º–µ–Ω–∞</button>
        <button id="modal-save" class="bg-blue-600 text-white px-4 py-2 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="message-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-4 rounded shadow-xl w-full max-w-md space-y-2">
      <h2 class="text-xl font-semibold">–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</h2>
      <select id="msg-emp" class="border p-2 w-full"></select>
      <textarea id="msg-text" class="border p-2 w-full" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"></textarea>
      <div class="flex gap-2 text-sm">
        <button onclick="applyFormat('b')" class="px-2 py-1 border rounded">B</button>
        <button onclick="applyFormat('i')" class="px-2 py-1 border rounded">I</button>
        <button onclick="applyFormat('s')" class="px-2 py-1 border rounded">S</button>
        <button onclick="applyFormat('a')" class="px-2 py-1 border rounded">A</button>
      </div>
      <input id="msg-photo" type="file" accept="image/*" class="border p-2 w-full">
      <div class="space-x-4 text-sm">
        <label><input type="radio" name="msg-format" value="HTML" checked> HTML</label>
        <label><input type="radio" name="msg-format" value="Markdown"> Markdown</label>
      </div>
      <label class="text-sm"><input type="checkbox" id="msg-ack" class="mr-1">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É '–ü—Ä–∏–Ω—è—Ç–æ'</label>
      <div class="flex justify-end gap-2 pt-2">
        <button onclick="closeMessageModal()" class="px-4 py-2">–û—Ç–º–µ–Ω–∞</button>
        <button onclick="sendPersonalMessage()" class="bg-blue-600 text-white px-4 py-2 rounded">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="broadcast-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-4 rounded shadow-xl w-full max-w-md space-y-2">
      <h2 class="text-xl font-semibold">–û–±—â–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h2>
      <textarea id="broadcast-text" class="border p-2 w-full" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"></textarea>
      <input id="broadcast-photo" class="border p-2 w-full" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
      <div class="space-x-4">
        <label><input type="radio" name="broadcast-format" value="HTML" checked> HTML</label>
        <label><input type="radio" name="broadcast-format" value="Markdown"> Markdown</label>
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button onclick="closeBroadcastModal()" class="px-4 py-2">–û—Ç–º–µ–Ω–∞</button>
        <button onclick="sendBroadcast()" class="bg-blue-600 text-white px-4 py-2 rounded">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="payout-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-4 rounded shadow-xl w-full max-w-md space-y-2">
      <h2 class="text-xl font-semibold">–°–æ–∑–¥–∞—Ç—å –≤—ã–ø–ª–∞—Ç—É</h2>
      <select id="payout-emp" class="border p-2 w-full"></select>
      <input id="payout-amount" type="number" class="border p-2 w-full" placeholder="–°—É–º–º–∞">
      <select id="payout-type" class="border p-2 w-full">
        <option value="–ê–≤–∞–Ω—Å">–ê–≤–∞–Ω—Å</option>
        <option value="–ó–ü">–ó–ü</option>
        <option value="–î–æ–ø–ª–∞—Ç–∞">–î–æ–ø–ª–∞—Ç–∞</option>
      </select>
      <select id="payout-method" class="border p-2 w-full">
        <option value="üí≥ –ù–∞ –∫–∞—Ä—Ç—É">üí≥ –ù–∞ –∫–∞—Ä—Ç—É</option>
        <option value="üè¶ –ò–∑ –∫–∞—Å—Å—ã">üè¶ –ò–∑ –∫–∞—Å—Å—ã</option>
        <option value="ü§ù –ù–∞–ª–∏—á–Ω—ã–º–∏">ü§ù –ù–∞–ª–∏—á–Ω—ã–º–∏</option>
      </select>
      <label class="flex items-center mt-2">
        <input type="checkbox" id="syncToBot" class="mr-2" />
        –û—Ç—Ä–∞–∑–∏—Ç—å –≤ –±–æ—Ç–µ
      </label>
      <div class="flex justify-end gap-2 pt-2">
        <button onclick="closePayoutModal()" class="px-4 py-2">–û—Ç–º–µ–Ω–∞</button>
        <button id="payout-save-btn" onclick="submitPayout()" class="bg-blue-600 text-white px-4 py-2 rounded">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="vacation-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-4 rounded shadow-xl w-full max-w-md space-y-2">
      <h2 id="vacation-modal-title" class="text-xl font-semibold">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—É—Å–∫</h2>
      <select id="vac-emp" class="border p-2 w-full"></select>
      <input type="date" id="vac-start" class="border p-2 w-full">
      <input type="date" id="vac-end" class="border p-2 w-full">
      <select id="vac-type" class="border p-2 w-full">
        <option value="–û—Ç–ø—É—Å–∫">–û—Ç–ø—É—Å–∫</option>
        <option value="–ë–æ–ª—å–Ω–∏—á–Ω—ã–π">–ë–æ–ª—å–Ω–∏—á–Ω—ã–π</option>
        <option value="–ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞">–ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞</option>
      </select>
      <textarea id="vac-comment" class="border p-2 w-full" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
      <div class="flex justify-between items-center pt-2">
        <button id="vac-delete" class="text-red-600 hidden">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        <div class="flex gap-2">
          <button onclick="closeVacationModal()" class="px-4 py-2">–û—Ç–º–µ–Ω–∞</button>
          <button id="vac-save" class="bg-blue-600 text-white px-4 py-2 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <div id="adj-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-4 rounded shadow-xl w-full max-w-md space-y-2">
      <h2 class="text-xl font-semibold">–ó–∞–ø–∏—Å—å</h2>
      <select id="adj-emp" class="border p-2 w-full"></select>
      <select id="adj-type" class="border p-2 w-full">
        <option value="–£–¥–µ—Ä–∂–∞–Ω–∏–µ">–£–¥–µ—Ä–∂–∞–Ω–∏–µ</option>
        <option value="–ü—Ä–µ–º–∏—è">–ü—Ä–µ–º–∏—è</option>
      </select>
      <select id="adj-reason" class="border p-2 w-full"></select>
      <input id="custom-adj-reason" class="border p-2 w-full hidden" placeholder="–ü—Ä–∏—á–∏–Ω–∞" />
      <input id="adj-amount" type="number" min="0" class="border p-2 w-full" placeholder="–°—É–º–º–∞">
      <input id="adj-date" type="date" class="border p-2 w-full">
      <select id="adj-status" class="border p-2 w-full">
        <option value="–ê–∫—Ç–∏–≤–Ω–æ">–ê–∫—Ç–∏–≤–Ω–æ</option>
        <option value="–°–Ω—è—Ç–æ">–°–Ω—è—Ç–æ</option>
      </select>
      <div class="flex justify-end gap-2 pt-2">
        <button onclick="closeAdjModal()" class="px-4 py-2">–û—Ç–º–µ–Ω–∞</button>
        <button id="adj-save" class="bg-blue-600 text-white px-4 py-2 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed top-2 right-2 px-4 py-2 rounded shadow hidden"></div>

  <script>
    let employees = [];
    let editingId = null;
    let lastPayouts = [];

    function showSection(id) {
      document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
      const el = document.getElementById(id);
      if (el) {
        el.classList.remove('hidden');
        if (id === 'payouts') {
          const sel = document.getElementById('payout-employee-filter');
          sel.innerHTML = '<option value="">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>' + employees.map(e => `<option value="${e.id}">${e.full_name || e.name}</option>`).join('');
          fetchPayouts();
        }
        if (id === 'adjustments') {
          loadAdjustments();
        }
        if (id === 'vacations') {
          loadVacations();
        }
        if (id === 'birthdays') {
          loadBirthdays();
        }
        if (id === 'messages') {
          loadMessages();
        }
        if (id === 'requests') {
          loadActiveRequests();
        }
      }
    }

    function addNotify(text) {
      const list = document.getElementById('notify-list');
      const item = document.createElement('li');
      item.textContent = text;
      list.prepend(item);
      document.getElementById('notifications').classList.remove('hidden');
    }

    async function loadEmployees() {
      try {
        const res = await axios.get('/api/employees/');
        employees = res.data;
        renderTable();
        document.getElementById('stat-total').textContent = employees.length;
      } catch (err) {
        console.error(err);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', true);
      }
    }

    async function loadBirthdays() {
      try {
        const res = await axios.get('/api/birthdays/');
        const body = document.getElementById('birthdays-body');
        body.innerHTML = res.data.map(p => `
          <tr class='border-b odd:bg-gray-50'>
            <td class='p-2'>${p.full_name}</td>
            <td class='p-2'>${new Date(p.birthdate).toLocaleDateString()}</td>
            <td class='p-2'>${p.age}</td>
            <td class='p-2'>${p.in_days === 0 ? '–°–µ–≥–æ–¥–Ω—è üéâ' : p.in_days + ' –¥–Ω.'}</td>
          </tr>`).join('');
        if (res.data.length) {
          document.getElementById('stat-birthday').textContent = new Date(res.data[0].birthdate).toLocaleDateString();
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function loadMessages() {
      try {
        const res = await axios.get('/api/messages/');
        const body = document.getElementById('messages-body');
        body.innerHTML = res.data.map(m => {
          const photo = m.photo ? '‚úÖ' : '‚ùå';
          const ts = new Date(m.timestamp).toLocaleString();
          let status = m.status;
          if (m.accepted) {
            const at = m.timestamp_accept ? new Date(m.timestamp_accept).toLocaleString() : '';
            status = `‚úÖ –ü—Ä–∏–Ω—è—Ç–æ${at ? ' –≤ ' + at : ''}`;
          }
          const action = m.accepted ? '' : `<button class='text-blue-600' onclick="acceptMessage('${m.id}')">–ü—Ä–∏–Ω—è—Ç–æ</button>`;
          return `<tr class='border-b odd:bg-gray-50'><td class='p-2'>${m.name}</td><td class='p-2'>${m.text}</td><td class='p-2'>${photo}</td><td class='p-2'>${ts}</td><td class='p-2'>${status}</td><td class='p-2'>${action}</td></tr>`;
        }).join('');
      } catch (err) {
        console.error(err);
      }
    }

    function renderTable(list = employees) {
      const tbody = document.querySelector('#employee-table tbody');
      const thead = document.querySelector('#employee-table thead');
      thead.innerHTML = `<tr>
        <th class='p-2 text-left'>–ò–º—è</th>
        <th class='p-2 text-left'>–§–ò–û</th>
        <th class='p-2 text-left'>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
        <th class='p-2 text-left'>–¢–µ–ª–µ—Ñ–æ–Ω</th>
        <th class='p-2 text-left'>–ë–∞–Ω–∫</th>
        <th class='p-2 text-left'>–°—Ç–∞—Ç—É—Å</th>
        <th class='p-2 text-left'>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>`;
      tbody.innerHTML = list.map(e => `
        <tr class='border-b odd:bg-gray-50'>
          <td class='p-2'>${e.name || ''}</td>
          <td class='p-2'>${e.full_name || ''}</td>
          <td class='p-2'>${e.birthdate || ''}</td>
          <td class='p-2'>${e.phone || ''}</td>
          <td class='p-2'>${e.bank || ''}</td>
          <td class='p-2'>${e.status}</td>
          <td class='p-2 whitespace-nowrap'>
            <button onclick="openProfile('${e.id}')" class='text-green-600 mr-2'>üìÑ –ü—Ä–æ—Ñ–∏–ª—å</button>
            <button onclick="openModal('${e.id}')" class='text-blue-600 mr-2'>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button onclick="deleteEmployee('${e.id}')" class='text-red-600'>–£–¥–∞–ª–∏—Ç—å</button>
          </td>
        </tr>`).join('');
    }

    function applyFilters() {
      const name = document.getElementById('filter-name').value.toLowerCase();
      const status = document.getElementById('filter-status').value;
      const from = document.getElementById('filter-from').value;
      const to = document.getElementById('filter-to').value;
      const filtered = employees.filter(e => {
        const matchName = !name || (e.name?.toLowerCase().includes(name) || e.full_name?.toLowerCase().includes(name));
        const matchStatus = !status || e.status === status;
        const bd = e.birthdate ? new Date(e.birthdate) : null;
        const matchFrom = !from || (bd && bd >= new Date(from));
        const matchTo = !to || (bd && bd <= new Date(to));
        return matchName && matchStatus && matchFrom && matchTo;
      });
      renderTable(filtered);
    }

    function openModal(id = null) {
      editingId = id;
      document.getElementById('modal').classList.remove('hidden');
      const title = document.getElementById('modal-title');
      const idInput = document.getElementById('emp-id');
      if (id) {
        const emp = employees.find(e => e.id === id);
        if (!emp) return;
        title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
        idInput.value = emp.id;
        idInput.disabled = true;
        document.getElementById('emp-name').value = emp.name || '';
        document.getElementById('emp-full_name').value = emp.full_name || '';
        document.getElementById('emp-birthdate').value = emp.birthdate || '';
        document.getElementById('emp-phone').value = emp.phone || '';
        document.getElementById('emp-bank').value = emp.bank || '';
        document.getElementById('emp-status').value = emp.status;
        document.getElementById('emp-note').value = emp.note || '';
      } else {
        title.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞';
        document.querySelectorAll('#modal input, #modal textarea').forEach(el => el.value = '');
        idInput.disabled = false;
        document.getElementById('emp-status').value = 'active';
      }
    }

   function closeModal() {
     document.getElementById('modal').classList.add('hidden');
      document.getElementById('emp-id').disabled = false;
      editingId = null;
   }

    document.getElementById('modal-save').onclick = async () => {
      const base = {
        name: document.getElementById('emp-name').value,
        full_name: document.getElementById('emp-full_name').value,
        phone: document.getElementById('emp-phone').value,
        card_number: '',
        bank: document.getElementById('emp-bank').value,
        birthdate: document.getElementById('emp-birthdate').value || null,
        note: document.getElementById('emp-note').value,
        photo_url: '',
        status: document.getElementById('emp-status').value,
      };
      const data = editingId ? base : { id: document.getElementById('emp-id').value, ...base };
      const file = document.getElementById('emp-photo').files[0];
      try {
        if (editingId) {
          await axios.put(`/api/employees/${editingId}`, data);
          if (file) {
            const form = new FormData();
            form.append('file', file);
            await axios.post(`/api/employees/${editingId}/photo`, form);
          }
          showToast('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        } else {
          const res = await axios.post('/api/employees/', data);
          const id = res.data.id;
          if (file) {
            const form = new FormData();
            form.append('file', file);
            await axios.post(`/api/employees/${id}/photo`, form);
          }
          showToast('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω');
        }
        closeModal();
        await loadEmployees();
      } catch (err) {
        console.error(err);
        showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', true);
      }
    };

    async function deleteEmployee(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) return;
      try {
        await axios.delete(`/api/employees/${id}`);
        showToast('–£–¥–∞–ª–µ–Ω–æ');
        await loadEmployees();
      } catch (err) {
        console.error(err);
        showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', true);
      }
    }

    function openProfile(id) {
      window.open(`/api/employees/${id}/profile.pdf`, '_blank');
    }

    function showToast(text, error=false) {
      const toast = document.getElementById('toast');
      toast.textContent = text;
      toast.className = `fixed top-2 right-2 px-4 py-2 rounded shadow ${error ? 'bg-red-500' : 'bg-green-500'} text-white`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    async function openMessageModal() {
      try {
        const res = await axios.get('/api/employees/');
        const select = document.getElementById('msg-emp');
        select.innerHTML = res.data.map(e => `<option value="${e.id}">${e.full_name || e.name}</option>`).join('');
        document.getElementById('msg-text').value = '';
        document.getElementById('msg-photo').value = '';
        document.getElementById('msg-ack').checked = false;
        document.querySelector('input[name="msg-format"][value="HTML"]').checked = true;
        document.getElementById('message-modal').classList.remove('hidden');
      } catch (err) {
        console.error(err);
      }
    }

    function closeMessageModal() {
      document.getElementById('message-modal').classList.add('hidden');
    }

    function applyFormat(tag) {
      const ta = document.getElementById('msg-text');
      const start = ta.selectionStart;
      const end = ta.selectionEnd;
      let open = `<${tag}>`, close = `</${tag}>`;
      if (tag === 'a') {
        const url = prompt('URL');
        if (!url) return;
        open = `<a href="${url}">`; close = '</a>';
      }
      const selected = ta.value.slice(start, end);
      ta.setRangeText(open + selected + close, start, end, 'end');
      ta.focus();
    }

    async function sendPersonalMessage() {
      const userId = document.getElementById('msg-emp').value;
      const text = document.getElementById('msg-text').value;
      const requireAck = document.getElementById('msg-ack').checked;
      if (!userId || !text.trim()) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.');
        return;
      }
      const form = new FormData();
      form.append('user_id', userId);
      form.append('message', text);
      form.append('require_ack', requireAck);
      const file = document.getElementById('msg-photo').files[0];
      if (file) form.append('photo', file);
      try {
        await axios.post('/api/messages/', form);
        addNotify(`–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId}`);
        closeMessageModal();
        loadMessages();
      } catch (err) {
        console.error(err);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ');
      }
    }

    async function acceptMessage(id) {
      try {
        await axios.post(`/api/messages/${id}/accept`);
        loadMessages();
      } catch (err) {
        console.error(err);
      }
    }

    function openBroadcastModal() {
      document.getElementById('broadcast-text').value = '';
      document.getElementById('broadcast-photo').value = '';
      document.getElementById('broadcast-modal').classList.remove('hidden');
    }

    function closeBroadcastModal() {
      document.getElementById('broadcast-modal').classList.add('hidden');
    }

    async function sendBroadcast() {
      const text = document.getElementById('broadcast-text').value;
      const photo = document.getElementById('broadcast-photo').value;
      const mode = document.querySelector("input[name='broadcast-format']:checked").value;
      try {
        await axios.post('/api/telegram/broadcast', { message: text, parse_mode: mode, photo_url: photo || null });
        addNotify('–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
        closeBroadcastModal();
      } catch (err) {
        console.error(err);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ');
      }
    }

    async function populateSalaryFilters() {
      try {
        const res = await axios.get('/api/salary/months');
        const monthSel = document.getElementById('salary-month-filter');
        monthSel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>' +
          res.data.map(m => `<option value="${m}">${m}</option>`).join('');
        monthSel.onchange = fetchSalaryData;
      } catch (err) {
        console.error(err);
      }
      const empSel = document.getElementById('salary-employee-filter');
      empSel.innerHTML = '<option value="">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>' +
        employees.map(e => `<option value="${e.id}">${e.full_name || e.name}</option>`).join('');
      empSel.onchange = fetchSalaryData;
    }

    async function fetchSalaryData() {
      const month = document.getElementById('salary-month-filter').value;
      const emp = document.getElementById('salary-employee-filter').value;
      try {
        const res = await axios.get('/api/salary/', { params: { month, employee_id: emp } });
        renderSalaryTable(res.data);
      } catch (err) {
        console.error(err);
      }
    }

    function formatRub(amount) {
      const num = Number(amount) || 0;
      return num.toLocaleString('ru-RU') + ' ‚ÇΩ';
    }

    function renderSalaryTable(data) {
      const container = document.getElementById('salary-table-container');
      if (!data || !data.length) {
        container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
      }
      let html = `<table class='min-w-full text-sm'><thead>
        <tr class='bg-gray-200'>
          <th rowspan="2" class='p-2 text-left'>–ò–º—è</th>
          <th rowspan="2" class='p-2 text-left'>–ú–µ—Å—è—Ü</th>
          <th colspan="3" class='p-2 text-center'>–ò–¢–û–ì–û –°–ú–ï–ù</th>
          <th colspan="10" class='p-2 text-center'>–†–ê–°–ß–Å–¢ –ó–ü</th>
          <th colspan="4"></th>
        </tr>
        <tr class='bg-gray-100'>
          <th class='p-1'>–û–°–ù.</th><th class='p-1'>–î–û–ü.</th><th class='p-1'>–û–ë–©.</th>
          <th class='p-1'>–û–ö–õ–ê–î</th><th class='p-1'>–†–µ–º–æ–Ω—Ç</th><th class='p-1'>–ö–æ—Å–º–µ—Ç–∏–∫–∞</th><th class='p-1'>–û–±—É–≤—å</th><th class='p-1'>–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</th><th class='p-1'>–ö–ª—é—á–∏</th><th class='p-1'>–¢–∞–ø–∫–∏</th><th class='p-1'>–¶–µ—Ö</th><th class='p-1'>–ë–æ–Ω—É—Å</th>
          <th class='p-1 font-semibold'>–ò–¢–û–ì–û</th><th class='p-1'>–£–¥–µ—Ä–∂–∞–Ω–∏–µ</th><th class='p-1'>–ê–≤–∞–Ω—Å</th><th class='p-1 font-semibold'>–ö –≤—ã–ø–ª–∞—Ç–µ</th>
        </tr>
        </thead><tbody>`;
      html += data.map(r => `
        <tr class='border-b odd:bg-gray-50'>
          <td class='p-2'>${r.name}</td>
          <td class='p-2'>${r.month}</td>
          <td class='p-2'>${r.shifts_main}</td>
          <td class='p-2'>${r.shifts_extra}</td>
          <td class='p-2'>${r.shifts_total}</td>
          <td class='p-2'>${formatRub(r.salary_fixed)}</td>
          <td class='p-2'>${formatRub(r.salary_repair)}</td>
          <td class='p-2'>${formatRub(r.salary_cosmetics)}</td>
          <td class='p-2'>${formatRub(r.salary_shoes)}</td>
          <td class='p-2'>${formatRub(r.salary_accessories)}</td>
          <td class='p-2'>${formatRub(r.salary_keys)}</td>
          <td class='p-2'>${formatRub(r.salary_slippers)}</td>
          <td class='p-2'>${formatRub(r.salary_workshop)}</td>
          <td class='p-2'>${formatRub(r.salary_bonus)}</td>
          <td class='p-2 font-semibold'>${formatRub(r.salary_total)}</td>
          <td class='p-2'>${formatRub(r.deduction)}</td>
          <td class='p-2'>${formatRub(r.advance)}</td>
          <td class='p-2 font-semibold'>${formatRub(r.final_amount)}</td>
        </tr>`).join('');
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function showSalary() {
      showSection('salary');
      await populateSalaryFilters();
      await fetchSalaryData();
    }

    function showSchedule() {
      showSection('schedule');
      const input = document.getElementById('schedule-date-picker');
      if (!input.value) {
        input.value = new Date().toISOString().slice(0, 10);
      }
      loadScheduleByDay();
    }

    function loadScheduleByDay() {
      const date = document.getElementById('schedule-date-picker').value;
      if (!date) return;
      axios.get('/api/schedule/by_day', { params: { date } }).then(res => {
        const body = document.getElementById('schedule-by-day-body');
        body.innerHTML = '';
        const colors = {
          '–¶–µ—Ö': '#7D3C98',
          '–û—Ö—Ç–∞': '#239B56',
          '–ú–µ—Ä–∫—É—Ä–∏–π': '#1E8449',
          '–ê–∫–∞–¥–µ–º–∫–∞': '#F4D03F',
          '–û–∑–µ—Ä–∫–∏': '#F5B041',
          '–ü–∞—Å—Å–∞–∂': '#85C1E9',
          '–†–∏–æ': '#E59866'
        };
        res.data.forEach(item => {
          const color = colors[item.point] || '#ffffff';
          body.innerHTML += `<tr><td style="background-color:${color};font-weight:bold;">${item.point}</td><td>${item.employee || '-'}</td></tr>`;
        });
      }).catch(err => console.error(err));
    }

    async function fetchPayouts() {
      const params = {
        payout_type: document.getElementById('payout-type-filter').value,
        status: document.getElementById('payout-status-filter').value,
        employee_id: document.getElementById('payout-employee-filter').value,
        from_date: document.getElementById('payout-from').value,
        to_date: document.getElementById('payout-to').value,
      };
      try {
        const res = await axios.get('/api/payouts/', { params });
        lastPayouts = res.data;
        renderPayoutTable(lastPayouts);
      } catch (err) {
        console.error(err);
      }
    }

    function renderPayoutTable(data) {
      const body = document.getElementById('payouts-body');
      body.innerHTML = data.map(p => `
        <tr class='border-b odd:bg-gray-50'>
          <td class='p-2'><input type="checkbox" class="payout-check" value="${p.id}"></td>
          <td class='p-2'>${p.name}</td>
          <td class='p-2'>${p.payout_type}</td>
          <td class='p-2'>${p.method}</td>
          <td class='p-2'>${formatRub(p.amount)}</td>
          <td class='p-2'>${p.status}</td>
          <td class='p-2'>${p.timestamp}</td>
          <td class='p-2 flex gap-2'>
            <button onclick="openEditPayout(${p.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
            <button onclick="deletePayout(${p.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            ${p.status === '–í –æ–∂–∏–¥–∞–Ω–∏–∏' ? `
              <button onclick="approvePayout(${p.id})" class='text-green-600'>‚úÖ</button>
              <button onclick="rejectPayout(${p.id})" class='text-red-600'>‚ùå</button>
              <button onclick="payPayout(${p.id})" class='text-blue-600'>üí∏</button>
            ` : ''}
          </td>
        </tr>
      `).join('');
      const stats = document.getElementById('payoutStats');
      if (data.length) {
        const total = data.reduce((acc, p) => acc + (p.amount || 0), 0);
        document.getElementById('payoutCount').textContent = data.length;
        document.getElementById('payoutTotal').textContent = formatRub(total);
        stats.classList.remove('hidden');
      } else {
        stats.classList.add('hidden');
      }
    }

    async function approvePayout(id) {
      await axios.put(`/api/payouts/${id}`, { status: '–û–¥–æ–±—Ä–µ–Ω–æ' });
      fetchPayouts();
    }

    async function rejectPayout(id) {
      await axios.put(`/api/payouts/${id}`, { status: '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' });
      fetchPayouts();
    }

    async function payPayout(id) {
      await axios.put(`/api/payouts/${id}`, { status: '–í—ã–ø–ª–∞—á–µ–Ω–æ' });
      fetchPayouts();
    }

    // ---- Vacations ----
    let vacations = [];
    let vacEditing = null;
    let currentMonth = new Date();
    currentMonth.setDate(1);
    let filteredVacations = [];

    async function loadVacations() {
      const res = await axios.get('/api/vacations/');
      vacations = res.data;
      const filterSel = document.getElementById('vac-filter-employee');
      if (filterSel && !filterSel.dataset.filled) {
        filterSel.innerHTML = '<option value="">–í—Å–µ</option>' + employees.map(e => `<option value="${e.id}">${e.full_name || e.name}</option>`).join('');
        filterSel.dataset.filled = '1';
      }
      const modalSel = document.getElementById('vac-emp');
      if (modalSel) modalSel.innerHTML = employees.map(e => `<option value="${e.id}">${e.full_name || e.name}</option>`).join('');

      filteredVacations = [...vacations];
      const emp = filterSel?.value;
      const start = document.getElementById('vac-filter-start')?.value;
      const end = document.getElementById('vac-filter-end')?.value;
      const kw = document.getElementById('vac-filter-comment')?.value?.toLowerCase() || '';
      if (emp) filteredVacations = filteredVacations.filter(v => String(v.employee_id) === emp);
      if (start) filteredVacations = filteredVacations.filter(v => v.start_date >= start);
      if (end) filteredVacations = filteredVacations.filter(v => v.end_date <= end);
      if (kw) filteredVacations = filteredVacations.filter(v => (v.comment || '').toLowerCase().includes(kw));
      filteredVacations.sort((a,b) => new Date(a.start_date) - new Date(b.start_date));

      renderVacationCalendar();
    }

    function updateVacNav() {
      const nav = document.getElementById('vac-calendar-nav');
      if (!nav) return;
      const fmt = d => d.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
      const prev = new Date(currentMonth); prev.setMonth(prev.getMonth() - 1);
      const next = new Date(currentMonth); next.setMonth(next.getMonth() + 1);
      nav.innerHTML = `<button id="vac-prev" class="px-2">‚Üê ${fmt(prev)}</button>` +
        `<span class="font-semibold">${fmt(currentMonth)}</span>` +
        `<button id="vac-next" class="px-2">${fmt(next)} ‚Üí</button>` +
        `<button id="vac-today" class="border px-2 py-1 text-sm rounded ml-2">–°–µ–≥–æ–¥–Ω—è</button>`;
      document.getElementById('vac-prev').onclick = () => { currentMonth.setMonth(currentMonth.getMonth() - 1); renderVacationCalendar(); };
      document.getElementById('vac-next').onclick = () => { currentMonth.setMonth(currentMonth.getMonth() + 1); renderVacationCalendar(); };
      document.getElementById('vac-today').onclick = () => { currentMonth = new Date(); currentMonth.setDate(1); renderVacationCalendar(); };
    }

    function renderVacationCalendar() {
      const table = document.getElementById('vacation-table');
      if (!table) return;
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const days = new Date(year, month + 1, 0).getDate();
      if (!filteredVacations.length) {
        table.innerHTML = '<p class="p-4 text-center text-gray-500">–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–ø—É—Å–∫–æ–≤</p>';
        updateVacNav();
        return;
      }
      let head = '';
      for (let d = 1; d <= days; d++) head += `<th class="p-1 text-xs">${d}</th>`;
      const empIds = [...new Set(filteredVacations.map(v => v.employee_id))];
      const todayStr = new Date().toISOString().slice(0,10);
      let body = '';
      empIds.forEach(eid => {
        const name = employees.find(e => String(e.id) === String(eid))?.full_name || employees.find(e => String(e.id) === String(eid))?.name || '';
        let row = `<th class="p-2 text-left sticky left-0 bg-white z-10">${name}</th>`;
        for (let d = 1; d <= days; d++) {
          const date = new Date(year, month, d).toISOString().slice(0,10);
          const vac = filteredVacations.find(v => String(v.employee_id) === String(eid) && v.start_date <= date && v.end_date >= date);
          let cls = '';
          let title = '';
          let id = '';
          if (vac) {
            id = vac.id;
            title = `${vac.start_date} - ${vac.end_date}${vac.comment ? ' ' + vac.comment : ''}`;
            if (vac.end_date < todayStr) cls = 'bg-gray-300';
            else if (vac.start_date <= todayStr && vac.end_date >= todayStr) cls = 'bg-yellow-200';
            else cls = 'bg-green-200';
          } else {
            const dow = new Date(year, month, d).getDay();
            if (dow === 0 || dow === 6) cls = 'bg-gray-50';
          }
          row += `<td class="border p-1 ${cls}" data-id="${id}" title="${title}"></td>`;
        }
        body += `<tr>${row}</tr>`;
      });
      table.innerHTML = `<thead class="bg-gray-100 sticky top-0"><tr><th class="p-2 text-left sticky left-0 bg-gray-100 z-20">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>${head}</tr></thead><tbody>${body}</tbody>`;
      updateVacNav();
      table.querySelectorAll('td[data-id]').forEach(td => { if (td.dataset.id) { td.onclick = () => openVacationModal(td.dataset.id); } });
    }

    function openVacationModal(id=null) {
      vacEditing = id;
      document.getElementById('vacation-modal').classList.remove('hidden');
      document.getElementById('vac-delete').classList.add('hidden');
      document.getElementById('vac-emp').disabled = false;
      document.querySelectorAll('#vacation-table td.highlight').forEach(td => td.classList.remove('ring-2','ring-blue-500','highlight'));
      if (id) {
        const v = vacations.find(x => x.id == id);
        if (!v) return;
        document.getElementById('vacation-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—É—Å–∫';
        document.getElementById('vac-emp').value = v.employee_id;
        document.getElementById('vac-start').value = v.start_date;
        document.getElementById('vac-end').value = v.end_date;
        document.getElementById('vac-type').value = v.type;
        document.getElementById('vac-comment').value = v.comment || '';
        document.getElementById('vac-delete').classList.remove('hidden');
        document.getElementById('vac-emp').disabled = true;
        document.querySelectorAll(`#vacation-table td[data-id='${id}']`).forEach(td => td.classList.add('ring-2','ring-blue-500','highlight'));
      } else {
        document.getElementById('vacation-modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—É—Å–∫';
        document.getElementById('vac-start').value = '';
        document.getElementById('vac-end').value = '';
        document.getElementById('vac-type').value = '–û—Ç–ø—É—Å–∫';
        document.getElementById('vac-comment').value = '';
      }
    }

    function closeVacationModal() {
      document.getElementById('vacation-modal').classList.add('hidden');
      document.querySelectorAll('#vacation-table td.highlight').forEach(td => td.classList.remove('ring-2','ring-blue-500','highlight'));
    }

    document.getElementById('vac-save')?.addEventListener('click', async () => {
      const payload = {
        employee_id: document.getElementById('vac-emp').value,
        name: employees.find(e => e.id === document.getElementById('vac-emp').value)?.full_name || '',
        start_date: document.getElementById('vac-start').value,
        end_date: document.getElementById('vac-end').value,
        type: document.getElementById('vac-type').value,
        comment: document.getElementById('vac-comment').value
      };
      if (vacEditing) {
        await axios.put(`/api/vacations/${vacEditing}`, payload);
      } else {
        await axios.post('/api/vacations/', payload);
      }
      closeVacationModal();
      loadVacations();
    });

    document.getElementById('vac-delete').addEventListener('click', async () => {
      if (!vacEditing) return;
      const v = vacations.find(x => String(x.id) === String(vacEditing));
      if (!v) return;
      const emp = employees.find(e => String(e.id) === String(v.employee_id))?.full_name || '';
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å –æ—Ç–ø—É—Å–∫ —Å ${v.start_date} –ø–æ ${v.end_date} –¥–ª—è ${emp}?`)) return;
      await axios.delete(`/api/vacations/${vacEditing}`);
      closeVacationModal();
      loadVacations();
    });

    async function deleteVacation(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
      await axios.delete(`/api/vacations/${id}`);
      loadVacations();
    }

    // ---- Adjustments ----
    let adjustments = [];
    let adjEditing = null;

    const adjReasons = {
      '–£–¥–µ—Ä–∂–∞–Ω–∏–µ': ['–û–ø–æ–∑–¥–∞–Ω–∏–µ', '–ü—Ä–æ–ø—É—Å–∫ —Å–º–µ–Ω—ã', '–ù–∞—Ä—É—à–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã', '–£—Ä–æ–Ω –∏–º—É—â–µ—Å—Ç–≤—É', '–î—Ä—É–≥–æ–µ'],
      '–ü—Ä–µ–º–∏—è': ['–ó–∞ –≤—ã—Ä—É—á–∫—É', '–ó–∞ –¥–æ–ø. —Å–º–µ–Ω—É', '–ó–∞ –∫–∞—á–µ—Å—Ç–≤–æ', '–ó–∞ –∫–ª–∏–µ–Ω—Ç–∞', '–î—Ä—É–≥–æ–µ']
    };

    function updateAdjReasonOptions() {
      const type = document.getElementById('adj-type').value;
      const sel = document.getElementById('adj-reason');
      sel.innerHTML = adjReasons[type].map(r => `<option value="${r}">${r}</option>`).join('');
      document.getElementById('custom-adj-reason').classList.add('hidden');
    }

    function getAdjReason() {
      const val = document.getElementById('adj-reason').value;
      if (val === '–î—Ä—É–≥–æ–µ') {
        return document.getElementById('custom-adj-reason').value;
      }
      return val;
    }

    async function loadAdjustments() {
      const res = await axios.get('/api/adjustments/');
      adjustments = res.data;
      renderAdjTable();
      const empSel = document.getElementById('adj-emp');
      if (empSel) empSel.innerHTML = employees.map(e => `<option value="${e.id}">${e.full_name || e.name}</option>`).join('');
    }

    function renderAdjTable() {
      const body = document.getElementById('adj-table');
      if (!body) return;
      body.innerHTML = adjustments.map(a => `
        <tr class='border-b odd:bg-gray-50'>
          <td class='p-2'>${a.employee_name}</td>
          <td class='p-2'>${a.record_type}</td>
          <td class='p-2'>${a.reason}</td>
          <td class='p-2'>${a.amount}</td>
          <td class='p-2'>${a.date}</td>
          <td class='p-2'>${a.status}</td>
          <td class='p-2 whitespace-nowrap'>
            <button onclick="openAdjModal(${a.id})" class='mr-2'>‚úèÔ∏è</button>
            <button onclick="deleteAdjustment(${a.id})">‚ùå</button>
          </td>
        </tr>`).join('');
    }

    function openAdjModal(id=null) {
      adjEditing = id;
      document.getElementById('adj-modal').classList.remove('hidden');
      updateAdjReasonOptions();
      if (id) {
        const item = adjustments.find(a => a.id === id);
        if (!item) return;
        document.getElementById('adj-emp').value = item.employee_id;
        document.getElementById('adj-type').value = item.record_type;
        updateAdjReasonOptions();
        document.getElementById('adj-reason').value = adjReasons[item.record_type].includes(item.reason) ? item.reason : '–î—Ä—É–≥–æ–µ';
        if (document.getElementById('adj-reason').value === '–î—Ä—É–≥–æ–µ') {
          document.getElementById('custom-adj-reason').classList.remove('hidden');
          document.getElementById('custom-adj-reason').value = item.reason;
        }
        document.getElementById('adj-amount').value = item.amount;
        document.getElementById('adj-date').value = item.date;
        document.getElementById('adj-status').value = item.status;
      } else {
        document.querySelectorAll('#adj-modal input').forEach(i => i.value='');
        document.getElementById('adj-type').value = '–£–¥–µ—Ä–∂–∞–Ω–∏–µ';
        updateAdjReasonOptions();
        document.getElementById('adj-status').value = '–ê–∫—Ç–∏–≤–Ω–æ';
      }
    }

    function closeAdjModal() {
      document.getElementById('adj-modal').classList.add('hidden');
    }

    document.getElementById('adj-type')?.addEventListener('change', updateAdjReasonOptions);
    document.getElementById('adj-reason')?.addEventListener('change', () => {
      document.getElementById('custom-adj-reason').classList.toggle('hidden', document.getElementById('adj-reason').value !== '–î—Ä—É–≥–æ–µ');
    });

    document.getElementById('adj-save')?.addEventListener('click', async () => {
      const payload = {
        employee_id: document.getElementById('adj-emp').value,
        employee_name: employees.find(e => e.id === document.getElementById('adj-emp').value)?.full_name || '',
        record_type: document.getElementById('adj-type').value,
        reason: getAdjReason(),
        amount: Number(document.getElementById('adj-amount').value),
        date: document.getElementById('adj-date').value,
        status: document.getElementById('adj-status').value,
      };
      if (adjEditing) {
        await axios.put(`/api/adjustments/${adjEditing}`, payload);
      } else {
        await axios.post('/api/adjustments/', payload);
      }
      closeAdjModal();
      loadAdjustments();
    });

    async function deleteAdjustment(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
      await axios.delete(`/api/adjustments/${id}`);
      loadAdjustments();
    }

    function resetPayoutFilters() {
      document.getElementById('payout-type-filter').value = '';
      document.getElementById('payout-status-filter').value = '';
      document.getElementById('payout-employee-filter').value = '';
      document.getElementById('payout-from').value = '';
      document.getElementById('payout-to').value = '';
      fetchPayouts();
    }

    function toggleAllPayouts(box) {
      document.querySelectorAll('.payout-check').forEach(cb => cb.checked = box.checked);
    }

    async function deletePayout(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É?')) return;
      await axios.delete(`/api/payouts/${id}`);
      fetchPayouts();
      showToast('–í—ã–ø–ª–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∞');
    }

    async function deleteSelectedPayouts() {
      const ids = Array.from(document.querySelectorAll('.payout-check:checked')).map(cb => cb.value);
      if (!ids.length) return;
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã?')) return;
      await axios.delete(`/api/payouts/`, { params: { ids: ids.join(',') } });
      fetchPayouts();
      showToast('–í—ã–ø–ª–∞—Ç—ã —É–¥–∞–ª–µ–Ω—ã');
    }

    async function loadActiveRequests() {
      try {
        const res = await axios.get('/api/payouts/active');
        const tbody = document.querySelector('#requests-table tbody');
        tbody.innerHTML = res.data.map(r => `
          <tr class='border-b odd:bg-gray-50'>
            <td class='p-2'>${r.name}</td>
            <td class='p-2'>${r.amount} ‚ÇΩ</td>
            <td class='p-2'>${r.method}</td>
            <td class='p-2'>${r.payout_type}</td>
            <td class='p-2'>${r.status}</td>
            <td class='p-2'>${new Date(r.timestamp).toLocaleString()}</td>
          </tr>`).join('');
        document.getElementById('stat-active').textContent = res.data.length;
      } catch (err) {
        console.error(err);
      }
    }

    let editingPayout = null;
    function openEditPayout(id) {
      const item = lastPayouts.find(p => p.id === id);
      if (!item) return;
      openPayoutModal(false);
      editingPayout = id;
      document.getElementById('payout-emp').value = item.user_id;
      document.getElementById('payout-amount').value = item.amount;
      document.getElementById('payout-type').value = item.payout_type;
      document.getElementById('payout-method').value = item.method;
      document.getElementById('syncToBot').checked = false;
      document.getElementById('payout-save-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    }

  function openPayoutModal(isNew = true) {
      const sel = document.getElementById('payout-emp');
      sel.innerHTML = employees.map(e => `<option value="${e.id}">${e.full_name || e.name}</option>`).join('');
      document.getElementById('payout-modal').classList.remove('hidden');
      if (isNew) {
        editingPayout = null;
        document.getElementById('payout-amount').value = '';
        document.getElementById('payout-type').value = '–ê–≤–∞–Ω—Å';
        document.getElementById('payout-method').value = 'üí≥ –ù–∞ –∫–∞—Ä—Ç—É';
        document.getElementById('syncToBot').checked = false;
        document.getElementById('payout-save-btn').textContent = '–°–æ–∑–¥–∞—Ç—å';
      }
  }

    function closePayoutModal() {
      document.getElementById('payout-modal').classList.add('hidden');
    }

    async function submitPayout() {
      const payload = {
        user_id: document.getElementById('payout-emp').value,
        name: employees.find(e => e.id === document.getElementById('payout-emp').value)?.full_name || '',
        phone: employees.find(e => e.id === document.getElementById('payout-emp').value)?.phone || '',
        bank: employees.find(e => e.id === document.getElementById('payout-emp').value)?.bank || '',
        amount: Number(document.getElementById('payout-amount').value || 0),
        method: document.getElementById('payout-method').value,
        payout_type: document.getElementById('payout-type').value,
        sync_to_bot: document.getElementById('syncToBot').checked
      };
      try {
        if (editingPayout === null) {
          await axios.post('/api/payouts/', payload);
          showToast('–í—ã–ø–ª–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞');
        } else {
          await axios.put(`/api/payouts/${editingPayout}`, payload);
          showToast('–í—ã–ø–ª–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
        }
        closePayoutModal();
        fetchPayouts();
      } catch (err) {
        console.error(err);
        showToast('–û—à–∏–±–∫–∞', true);
      }
    }

    window.onload = () => {
      loadEmployees();
      loadBirthdays();
      loadMessages();
      loadActiveRequests();
      loadVacations();
      loadAdjustments();
      const input = document.getElementById('schedule-date-picker');
      if (input) input.value = new Date().toISOString().slice(0, 10);
      showSection('employees');
      setInterval(loadMessages, 10000);
    };
  </script>
</body>
</html>
